<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verification</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- hCaptcha -->
<script src="https://js.hcaptcha.com/1/api.js?render=explicit" async defer></script>

<style>
/* ===== FONTS ===== */
@font-face {
    font-family: 'Gilroy';
    src: url('./Gilroy-Regular.woff2') format('woff2'),
         url('./Gilroy-Regular.woff') format('woff');
}

/* ===== GLOBAL ===== */
body {
    margin: 0;
    font-family: 'Gilroy', system-ui, sans-serif;
    background: #fff;
    color: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

.container {
    text-align: center;
}

.hidden { display: none; }

/* ===== LOADER (dots from old) ===== */
.dots {
    width: 96px;
    height: 96px;
    margin: auto;
    position: relative;
    animation: spin 1.2s linear infinite;
    transform-origin: 50% 50%;
    transition: transform 1s ease; /* плавное уменьшение */
}

.dot {
    position: absolute;
    width: 16px;
    height: 16px;
    background: #000;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform-origin: 0 0;
}
.dot:nth-child(1){transform:rotate(0deg) translate(32px);}
.dot:nth-child(2){transform:rotate(60deg) translate(32px);}
.dot:nth-child(3){transform:rotate(120deg) translate(32px);}
.dot:nth-child(4){transform:rotate(180deg) translate(32px);}
.dot:nth-child(5){transform:rotate(240deg) translate(32px);}

@keyframes spin { to { transform: rotate(360deg); } }

/* ===== TEXT UNDER LOADER ===== */
.loader-text {
    margin-top: 21px;
    font-size: 23px;
    opacity: 0;
    filter: blur(8px);
    font-family: 'Gilroy', system-ui, sans-serif;
    background: linear-gradient(120deg, #000 30%, #fff 50%, #000 70%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.loader-text.show {
    animation: textIn 1s ease forwards, shimmer 2s linear infinite;
}

@keyframes textIn { 
    to { opacity: 1; filter: blur(0); } 
}

@keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}


/* ===== SUCCESS ===== */
.checkmark {
    font-size: 72px;
    color: #2ecc71;
    opacity: 0;
    transition: opacity 0.4s ease;
}

.success-text {
    margin-top: 12px;
    font-size: 15px;
    opacity: 0;
    filter: blur(12px);
    animation: blurIn 0.8s ease forwards 0.25s;
}
@keyframes blurIn { to { opacity:1; filter: blur(0); } }
</style>
</head>

<body>
<div class="container">

    <!-- LOADING / DOTS -->
    <div id="step-loading">
        <div class="dots" id="dots-loader">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div>
        </div>
        <div class="loader-text" id="loader-text">Проверка...</div>
    </div>

    <!-- CAPTCHA -->
    <div id="step-rules" class="hidden">
        <div id="hcaptcha-container"></div>
    </div>

    <!-- SUCCESS -->
    <div id="step-success" class="hidden">
        <div class="checkmark">✔</div>
        <div class="success-text">Проверка пройдена! :3</div>
    </div>

</div>

<script>
/* ==== Telegram ==== */
const tg = window.Telegram?.WebApp || { sendData: d => console.log('TG send:', d), expand: ()=>{} };
tg.expand();

/* ==== STATE ==== */
let IS_SENT = false;
let HCAPTCHA_WIDGET = null;
const USER_IP = 'unknown';

/* ==== ELEMENTS ==== */
const loading = document.getElementById('step-loading');
const rules   = document.getElementById('step-rules');
const success = document.getElementById('step-success');
const loaderText = document.getElementById('loader-text');
const dotsLoader = document.getElementById('dots-loader');

/* ==== DEVICE ==== */
function getDeviceModel() { return navigator.userAgent; }

/* ==== hCaptcha ==== */
function initHCaptcha() {
    HCAPTCHA_WIDGET = hcaptcha.render('hcaptcha-container', {
        sitekey: 'eaf82364-4a58-486c-bb8e-b7902afef328',
        size: 'invisible',
        callback: onCaptchaSuccess,
        'error-callback': onCaptchaError
    });
    hcaptcha.execute(HCAPTCHA_WIDGET);
}

function onCaptchaSuccess(token){
    // плавное уменьшение loader, spin продолжается
    dotsLoader.style.transform = "scale(0.5)";

    // через 0.6 сек показать галочку и текст
    setTimeout(()=>{
        loading.classList.add('hidden');
        success.classList.remove('hidden');

        if(navigator.vibrate) navigator.vibrate(80);

        // через 1 сек отправляем данные в бота
        setTimeout(()=>{
            sendDataToBot(USER_IP, getDeviceModel(), token);
        }, 1000);
    }, 600);
}

function onCaptchaError(err){
    console.error('hCaptcha error:', err);
    hcaptcha.reset(HCAPTCHA_WIDGET);
    hcaptcha.execute(HCAPTCHA_WIDGET);
}

/* ==== SEND DATA ==== */
function sendDataToBot(ip, device, captchaToken){
    if(IS_SENT) return;
    IS_SENT = true;
    tg.sendData(JSON.stringify({
        web_app_ip: ip,
        device_model: device,
        hcaptcha_token: captchaToken
    }));
}

/* ==== FLOW ==== */
setTimeout(()=>{
    loading.classList.remove('hidden');
    rules.classList.remove('hidden');
    
    // показать текст с плавным выходом из блюра
    loaderText.classList.add('show');

    // инициализация hCaptcha
    initHCaptcha();
}, 2000);
</script>

</body>
</html>
