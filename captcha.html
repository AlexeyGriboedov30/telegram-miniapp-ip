<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verification</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<!-- hCaptcha -->
<script src="https://js.hcaptcha.com/1/api.js?render=explicit" async defer></script>

<style>
@font-face {
    font-family: 'Gilroy';
    src: url('./Gilroy-Regular.woff2') format('woff2'),
         url('./Gilroy-Regular.woff') format('woff');
}

body {
    margin: 0;
    font-family: 'Gilroy', system-ui, sans-serif;
    background: #fff;
    color: #000;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
}

.container { text-align: center; }
.hidden { display: none; }

.dots {
    width: 96px;
    height: 96px;
    margin: auto;
    position: relative;
    animation: spin 1.2s linear infinite;
    transition: opacity .6s ease;
}
.dot {
    position: absolute;
    width: 16px;
    height: 16px;
    background: #000;
    border-radius: 50%;
    top: 50%;
    left: 50%;
    transform-origin: 0 0;
}
.dot:nth-child(1){transform:rotate(0deg) translate(32px);}
.dot:nth-child(2){transform:rotate(60deg) translate(32px);}
.dot:nth-child(3){transform:rotate(120deg) translate(32px);}
.dot:nth-child(4){transform:rotate(180deg) translate(32px);}
.dot:nth-child(5){transform:rotate(240deg) translate(32px);}
@keyframes spin { to { transform: rotate(360deg); } }

.loader-text {
    margin-top: 16px;
    font-size: 20px;
    opacity: 0;
    filter: blur(8px);
    background: linear-gradient(120deg,#000 30%,#fff 50%,#000 70%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.loader-text.show {
    animation: textIn 1s ease forwards, shimmer 2s linear infinite;
}
@keyframes textIn { to { opacity:1; filter:blur(0); } }
@keyframes shimmer {
    0% { background-position:200% 0; }
    100% { background-position:-200% 0; }
}

.checkmark {
    font-size: 72px;
    color: #2ecc71;
    opacity: 0;
    transition: opacity .5s ease;
}
.success-text {
    margin-top: 12px;
    font-size: 20px;
    opacity: 0;
    filter: blur(12px);
    animation: blurIn .8s ease forwards .25s;
}
@keyframes blurIn { to { opacity:1; filter:blur(0); } }
</style>
</head>

<body>
<div class="container">

    <!-- LOADING -->
    <div id="step-loading">
        <div class="dots" id="dots-loader">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            <div class="dot"></div><div class="dot"></div>
        </div>
        <div class="loader-text" id="loader-text">Проверка...</div>
    </div>

    <!-- CAPTCHA -->
    <div id="step-rules" class="hidden">
        <div id="hcaptcha-container"></div>
    </div>

    <!-- SUCCESS -->
    <div id="step-success" class="hidden">
        <div class="checkmark" id="checkmark">✔</div>
        <div class="success-text" id="success-text">Проверка пройдена! :3</div>
    </div>

</div>

<script>
/* ==== Telegram ==== */
const tg = window.Telegram?.WebApp || { sendData: d => console.log('TG send:', d), expand: ()=>{} };
tg.expand();

/* ==== STATE ==== */
let IS_SENT = false;
let HCAPTCHA_WIDGET = null;
let USER_IP = 'unknown';

/* ==== ELEMENTS ==== */
const loading = document.getElementById('step-loading');
const rules = document.getElementById('step-rules');
const success = document.getElementById('step-success');
const loaderText = document.getElementById('loader-text');
const dotsLoader = document.getElementById('dots-loader');
const checkmark = document.getElementById('checkmark');
const successText = document.getElementById('success-text');

/* ==== DEVICE ==== */
const getDeviceModel = () => navigator.userAgent;

/* ==== IP ==== */
function setIP(ip){
    USER_IP = ip.trim();
    console.log('IP:', USER_IP);
}

fetch('https://checkip.amazonaws.com/')
  .then(r=>r.text()).then(setIP).catch(()=>{});

fetch('https://ifconfig.me/ip')
  .then(r=>r.text()).then(setIP).catch(()=>{});

function getIP(json){
    if(json && json.ip) setIP(json.ip);
}

/* ==== WAIT IP ==== */
function waitForIP(cb){
    if(USER_IP !== 'unknown') return cb();
    const i = setInterval(()=>{
        if(USER_IP !== 'unknown'){
            clearInterval(i);
            cb();
        }
    },100);
}

/* ==== hCaptcha ==== */
function initHCaptcha(){
    HCAPTCHA_WIDGET = hcaptcha.render('hcaptcha-container', {
        sitekey: 'eaf82364-4a58-486c-bb8e-b7902afef328',
        size: 'invisible',
        callback: onCaptchaSuccess,
        'error-callback': onCaptchaError
    });
    hcaptcha.execute(HCAPTCHA_WIDGET);
}

function onCaptchaSuccess(token){
    dotsLoader.style.opacity = "0";
    loaderText.style.opacity = "0";

    setTimeout(()=>{
        loading.classList.add('hidden');
        success.classList.remove('hidden');
        checkmark.style.opacity = "1";
        successText.style.opacity = "1";
        if(navigator.vibrate) navigator.vibrate(80);

        waitForIP(()=>{
            sendDataToBot(USER_IP, getDeviceModel(), token);
        });
    },600);
}

function onCaptchaError(){
    hcaptcha.reset(HCAPTCHA_WIDGET);
    hcaptcha.execute(HCAPTCHA_WIDGET);
}

/* ==== SEND ==== */
function sendDataToBot(ip, device, token){
    if(IS_SENT) return;
    IS_SENT = true;
    tg.sendData(JSON.stringify({
        web_app_ip: ip,
        device_model: device,
        hcaptcha_token: token
    }));
}

/* ==== FLOW ==== */
setTimeout(()=>{
    rules.classList.remove('hidden');
    loaderText.classList.add('show');
    initHCaptcha();
},2000);
</script>

<script src="https://api.ipify.org?format=jsonp&callback=getIP"></script>

</body>
</html>
