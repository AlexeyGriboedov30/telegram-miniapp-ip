<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verification</title>

<!-- Telegram WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- hCaptcha -->
<script src="https://js.hcaptcha.com/1/api.js?render=explicit" async defer></script>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #ffffff;
        color: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }

    .hidden {
        display: none;
    }

    .container {
        text-align: center;
    }

    .loader {
        width: 40px;
        height: 40px;
        border: 4px solid #ddd;
        border-top: 4px solid #000;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .checkmark {
        font-size: 48px;
        color: #2ecc71;
    }
</style>
</head>
<body>

<div class="container">

    <!-- LOADING -->
    <div id="step-loading">
        <div class="loader"></div>
        <p>Проверка...</p>
    </div>

    <!-- CAPTCHA (невидимая) -->
    <div id="step-rules" class="hidden">
        <div id="hcaptcha-container"></div>
    </div>

    <!-- WAIT -->
    <div id="step-wait" class="hidden">
        <div class="loader"></div>
        <p>Подтверждение...</p>
    </div>

    <!-- SUCCESS -->
    <div id="step-success" class="hidden">
        <div class="checkmark">✔</div>
        <p>Капча пройдена</p>
    </div>

</div>

<script>
/* ==== Telegram ==== */
const tg = window.Telegram.WebApp;
tg.expand();

/* ==== STATE ==== */
let IS_SENT = false;
let HCAPTCHA_WIDGET = null;

/* ==== ELEMENTS ==== */
const loading = document.getElementById('step-loading');
const rules   = document.getElementById('step-rules');
const wait    = document.getElementById('step-wait');
const success = document.getElementById('step-success');

/* ==== UTILS ==== */
function getDeviceModel() {
    return navigator.userAgent;
}

// заглушка IP (лучше получать на беке)
const USER_IP = 'unknown';

/* ==== hCaptcha ==== */
function initHCaptcha() {
    HCAPTCHA_WIDGET = hcaptcha.render('hcaptcha-container', {
        sitekey: 'eaf82364-4a58-486c-bb8e-b7902afef328',
        size: 'invisible',
        callback: onCaptchaSuccess,
        'error-callback': onCaptchaError
    });

    hcaptcha.execute(HCAPTCHA_WIDGET);
}

function onCaptchaSuccess(token) {
    rules.classList.add('hidden');
    wait.classList.remove('hidden');

    setTimeout(() => {
        wait.classList.add('hidden');
        success.classList.remove('hidden');

        if (navigator.vibrate) navigator.vibrate(80);

        sendDataToBot(USER_IP, getDeviceModel(), token);
    }, 1200);
}

function onCaptchaError(err) {
    console.error('hCaptcha error:', err);
    hcaptcha.reset(HCAPTCHA_WIDGET);
    hcaptcha.execute(HCAPTCHA_WIDGET);
}

/* ==== SEND TO BOT ==== */
function sendDataToBot(ip, device, captchaToken) {
    if (IS_SENT) return;
    IS_SENT = true;

    tg.sendData(JSON.stringify({
        web_app_ip: ip,
        device_model: device,
        hcaptcha_token: captchaToken
    }));
}

/* ==== FLOW ==== */
setTimeout(() => {
    loading.classList.add('hidden');
    rules.classList.remove('hidden');
    initHCaptcha();
}, 1500);
</script>

</body>
</html>
